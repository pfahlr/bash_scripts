#!/bin/bash

if [ $# -lt 1 ] || [ $# -gt 2 ]; then
  echo "Usage: $0 path_to_task_list.txt [task_directory (default: codex/TASKS)]"
  exit 1
fi

TASK_FILE="$1"
TASK_DIR="${2:-codex/TASKS}"
LOG_FILE="codex_run_$(date +'%Y-%m-%d_%H-%M-%S').log"
TMUX_PREFIX="codex_task"
CODEX_CMD="codex"
WORKDIR=$(pwd)

if [ ! -f "$TASK_FILE" ]; then
  echo "‚ùå Task file '$TASK_FILE' not found."
  exit 1
fi

mapfile -t RAW_TASKS < "$TASK_FILE"
TASKS=()

for LINE in "${RAW_TASKS[@]}"; do
  [[ -z "$LINE" || "$LINE" =~ ^# ]] && continue
  BASE_TASK=$(basename "$LINE" .yml)
  BASE_TASK=$(basename "$BASE_TASK" .yaml)
  TASKS+=("$BASE_TASK")
done

echo "üöÄ Starting Codex Agent runner at $(date)" | tee -a "$LOG_FILE"
echo "Task file: $TASK_FILE" | tee -a "$LOG_FILE"
echo "Task directory: $TASK_DIR" | tee -a "$LOG_FILE"
echo "Working directory: $WORKDIR" | tee -a "$LOG_FILE"
echo "Tasks: ${TASKS[*]}" | tee -a "$LOG_FILE"
echo "=======================================" | tee -a "$LOG_FILE"

for TASK in "${TASKS[@]}"; do
  YAML_PATH="$TASK_DIR/${TASK}.yaml"
  TASK_LOG="tasklog_${TASK}_$(date +%s).log"
  TASK_DONE="${TASK_LOG}.done"

  if [ ! -f "$YAML_PATH" ]; then
    echo "‚ùå Spec not found: $YAML_PATH" | tee -a "$LOG_FILE"
    exit 1
  fi

  echo "üü° Executing task: $TASK" | tee -a "$LOG_FILE"

  # Prompt for Codex
  PROMPT="Implement the functionality described in ${YAML_PATH}, then verify with any available tests."

  # Run codex in tmux, capture log, and mark done
  tmux new-session -d -s "${TMUX_PREFIX}_${TASK}" \
    "codex exec --full-auto --cd \"$WORKDIR\" \"$PROMPT\" > \"$TASK_LOG\" 2>&1; touch \"$TASK_DONE\""

  while [ ! -f "$TASK_DONE" ]; do
    sleep 1
  done

  if grep -q -i "success\|completed\|all tests passed" "$TASK_LOG"; then
    echo "‚úÖ Task $TASK completed successfully." | tee -a "$LOG_FILE"
  else
    echo "‚ùå Task $TASK may have failed or not confirmed success." | tee -a "$LOG_FILE"
    echo "üìÑ Last 20 lines from $TASK_LOG:" | tee -a "$LOG_FILE"
    tail -n 20 "$TASK_LOG" | tee -a "$LOG_FILE"
    exit 1
  fi

  echo "---------------------------------------" | tee -a "$LOG_FILE"
done

echo "üéâ All tasks completed (or passed success detection)." | tee -a "$LOG_FILE"
