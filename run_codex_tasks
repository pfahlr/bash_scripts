#!/bin/bash

# === Usage Check ===
if [ $# -lt 1 ] || [ $# -gt 2 ]; then
  echo "Usage: $0 path_to_task_list.txt [task_directory (default: codex/TASKS)]"
  exit 1
fi

# === Input Parameters ===
TASK_FILE="$1"
TASK_DIR="${2:-codex/TASKS}"  # Default to codex/TASKS if not specified
LOG_FILE="codex_run_$(date +'%Y-%m-%d_%H-%M-%S').log"
TMUX_PREFIX="codex_task"
CODEX_CMD="codex run"
APPROVALS="full"

# === Verify Task File ===
if [ ! -f "$TASK_FILE" ]; then
  echo "‚ùå Error: Task file '$TASK_FILE' not found."
  exit 1
fi

# === Read & Normalize Tasks ===
mapfile -t RAW_TASKS < "$TASK_FILE"
TASKS=()

for LINE in "${RAW_TASKS[@]}"; do
  [[ -z "$LINE" || "$LINE" =~ ^# ]] && continue  # Skip blank lines and comments

  # Normalize extension to .yaml
  BASE_TASK=$(basename "$LINE" .yml)
  BASE_TASK=$(basename "$BASE_TASK" .yaml)
  TASKS+=("$BASE_TASK")
done

# === Log Header ===
echo "üöÄ Starting Codex task runner at $(date)" | tee -a "$LOG_FILE"
echo "Using task file: $TASK_FILE" | tee -a "$LOG_FILE"
echo "Task directory: $TASK_DIR" | tee -a "$LOG_FILE"
echo "Tasks: ${TASKS[*]}" | tee -a "$LOG_FILE"
echo "Log file: $LOG_FILE"
echo "=======================================" | tee -a "$LOG_FILE"

# === Execute Tasks ===
for TASK in "${TASKS[@]}"; do
  YAML_PATH="$TASK_DIR/${TASK}.yaml"
  TMUX_SESSION="${TMUX_PREFIX}_${TASK}"

  if [ ! -f "$YAML_PATH" ]; then
    echo "‚ùå Task spec not found: $YAML_PATH" | tee -a "$LOG_FILE"
    exit 1
  fi

  echo "üü° Starting task: $TASK" | tee -a "$LOG_FILE"

  # Kill existing session if any
  tmux has-session -t "$TMUX_SESSION" 2>/dev/null && tmux kill-session -t "$TMUX_SESSION"

  # Start tmux session and run Codex
  tmux new-session -d -s "$TMUX_SESSION" \
    "$CODEX_CMD --start $YAML_PATH --require-pass --test-mode=tmux --approvals=$APPROVALS --notes 'Auto-run of $TASK using tmux. Ensure all tests pass before continuing.'"

  # Wait and check
  sleep 2

  if tmux has-session -t "$TMUX_SESSION"; then
    echo "‚úÖ Task $TASK completed (check Codex output manually or logs inside tmux)." | tee -a "$LOG_FILE"
    tmux kill-session -t "$TMUX_SESSION"
  else
    echo "‚ùå Task $TASK failed or exited unexpectedly." | tee -a "$LOG_FILE"
    echo "Exiting task runner." | tee -a "$LOG_FILE"
    exit 1
  fi

  echo "---------------------------------------" | tee -a "$LOG_FILE"
done

echo "üéâ All tasks completed successfully." | tee -a "$LOG_FILE"
