#!/bin/bash

# === Parse Named Args ===
TASK_FILE=""
TASK_DIR="codex/TASKS"
LOG_DIR="codex/LOGS"
AUTO_COMMIT=false
CONFIG_FILE=""
WORKDIR=$(pwd)

while [[ $# -gt 0 ]]; do
  case "$1" in
    -t|--task-list)
      TASK_FILE="$2"
      shift 2
      ;;
    -d|--task-dir)
      TASK_DIR="$2"
      shift 2
      ;;
    -l|--log-dir)
      LOG_DIR="$2"
      shift 2
      ;;
    -m|--auto-commit)
      AUTO_COMMIT=true
      shift
      ;;
    -c|--config)
      CONFIG_FILE="$2"
      shift 2
      ;;
    *)
      echo "‚ùå Unknown argument: $1"
      echo "Usage: $0 --task-list <file> [--task-dir <dir>] [--log-dir <dir>] [--auto-commit] [--config <toml>]"
      exit 1
      ;;
  esac
done

if [[ -z "$TASK_FILE" ]]; then
  echo "‚ùå Missing required --task-list"
  exit 1
fi

if [ ! -f "$TASK_FILE" ]; then
  echo "‚ùå Task list file not found: $TASK_FILE"
  exit 1
fi

mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/codex_run_$(date +'%Y-%m-%d_%H-%M-%S').log"
TMUX_PREFIX="codex_task"
CODEX_CMD="codex"

# === Normalize task list ===
mapfile -t RAW_TASKS < "$TASK_FILE"
TASKS=()
for LINE in "${RAW_TASKS[@]}"; do
  [[ -z "$LINE" || "$LINE" =~ ^# ]] && continue
  BASE_TASK=$(basename "$LINE" .yml)
  BASE_TASK=$(basename "$BASE_TASK" .yaml)
  TASKS+=("$BASE_TASK")
done

# === Run header ===
echo "üöÄ Codex Runner @ $(date)" | tee -a "$LOG_FILE"
echo "Working Dir: $WORKDIR" | tee -a "$LOG_FILE"
echo "Task Dir: $TASK_DIR" | tee -a "$LOG_FILE"
echo "Log Dir: $LOG_DIR" | tee -a "$LOG_FILE"
echo "Auto-Commit: $AUTO_COMMIT" | tee -a "$LOG_FILE"
echo "Config File: $CONFIG_FILE" | tee -a "$LOG_FILE"
echo "Tasks: ${TASKS[*]}" | tee -a "$LOG_FILE"
echo "===========================================" | tee -a "$LOG_FILE"

# === Task Loop ===
for TASK in "${TASKS[@]}"; do
  YAML_PATH="$TASK_DIR/${TASK}.yaml"
  TASK_LOG="$LOG_DIR/tasklog_${TASK}_$(date +%s).log"
  TASK_DONE="${TASK_LOG}.done"
  GIT_DIFF_BEFORE=$(mktemp)

  if [ ! -f "$YAML_PATH" ]; then
    echo "‚ùå Spec not found: $YAML_PATH" | tee -a "$LOG_FILE"
    exit 1
  fi

  echo "üü° Executing task: $TASK" | tee -a "$LOG_FILE"
  PROMPT="Implement the functionality described in ${YAML_PATH}, then verify with any available tests."

  [[ "$AUTO_COMMIT" = true ]] && git diff --name-only > "$GIT_DIFF_BEFORE"

  # Build codex command
  CODEX_FULL_CMD="$CODEX_CMD exec --full-auto --cd \"$WORKDIR\""
  [[ -n "$CONFIG_FILE" ]] && CODEX_FULL_CMD+=" -c config_file=\"$CONFIG_FILE\""
  CODEX_FULL_CMD+=" \"$PROMPT\""

  # Execute in tmux
  tmux new-session -d -s "${TMUX_PREFIX}_${TASK}" \
    "bash -c '$CODEX_FULL_CMD > \"$TASK_LOG\" 2>&1; touch \"$TASK_DONE\"'"

  # Wait for task completion
  while [ ! -f "$TASK_DONE" ]; do
    sleep 1
  done

  # Success check
  if grep -i -q -e "success" -e "‚úî" -e "completed" "$TASK_LOG"; then
    echo "‚úÖ Task $TASK completed successfully." | tee -a "$LOG_FILE"
  else
    echo "‚ùå Task $TASK may have failed or not confirmed success." | tee -a "$LOG_FILE"
    tail -n 20 "$TASK_LOG" | tee -a "$LOG_FILE"
    exit 1
  fi

  # === Git Commit ===
  if [[ "$AUTO_COMMIT" = true ]]; then
    GIT_DIFF_AFTER=$(mktemp)
    git diff --name-only > "$GIT_DIFF_AFTER"

    # Determine new or modified files excluding the log dir
    MODIFIED=$(comm -13 "$GIT_DIFF_BEFORE" "$GIT_DIFF_AFTER" | grep -v "$LOG_DIR" || true)

    if [[ -n "$MODIFIED" ]]; then
      echo "üìù Committing files for $TASK..." | tee -a "$LOG_FILE"
      git add $MODIFIED

      COMMIT_MSG="Codex Task: $TASK

Summary:
- Task: $TASK
- Spec: $YAML_PATH

Codex Output:
$(tail -n 20 "$TASK_LOG")"

      git commit -m "$COMMIT_MSG" | tee -a "$LOG_FILE"
    else
      echo "‚ö†Ô∏è  No new or modified files detected for commit (excluding logs)." | tee -a "$LOG_FILE"
    fi

    rm "$GIT_DIFF_BEFORE" "$GIT_DIFF_AFTER"
  fi

  echo "-------------------------------------------" | tee -a "$LOG_FILE"
done

echo "üéâ All tasks completed successfully." | tee -a "$LOG_FILE"
